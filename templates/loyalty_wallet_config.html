{% extends 'nextify/base.html' %}
{% block main_content %}

<!-- <div class="c-toolbar u-mb-medium">
    <h3 class="c-toolbar__title has-divider">Ví tích tiền</h3>
    <h5 class="c-toolbar__meta u-mr-auto">Cấu hình tích ví</h5>

</div> -->
<input type="hidden" value="{{ loyal_settings.loyal_type }}" id="loyal_type_has" />
<div class="header">
    <div class="container-fluid">
        <div class="header-body">
            <div class="row align-items-end">
                <div class="col">

                    <!-- Pretitle -->
                    <h6 class="header-pretitle">
                        {{ gettext("Khach_Hang_Than_Thiet") }}
                    </h6>

                    <!-- Title -->
                    <h1 class="header-title">
                        {{ gettext("Thiet_lap_cau_hinh") }}
                    </h1>

                </div>
                <div class="col-auto">
                    <!--    {% if 'locations' in request.path %}
                 <a href="#new_location" class="btn btn-primary  mb-2" data-toggle="modal">
                                <i class="fa user-tag"></i> Thêm địa điểm
                            </a>
                {% endif %} -->
                </div>
            </div> <!-- / .row -->
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="c-toolbar u-mb-medium">
        <div class="col-lg-12">
            <div style="float: left" >
                <ul class="nav nav-tabs nav-overflow header-tabs">
                    <!-- <li class="nav-item">
                        <a class="nav-link" href="">
                            <h3 class="c-toolbar__title has-divider">Tích ví</h3>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="">
                            <h3 class="c-toolbar__title has-divider">Thanh toán</h3>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="">
                            <h3 class="c-toolbar__title has-divider">Hóa đơn</h3>
                        </a>
                    </li> -->
                    <li class="nav-item">
                        <a class="nav-link active" href="">
                            <h3 class="c-toolbar__title has-divider">{{ gettext("Cau_hinh") }}</h3>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="col-lg-3" style="float: right; margin-top: 20px;" >
                <select class="browser-default custom-select" id="loyal_type" style="margin-top: 70px;">
                    <option disabled selected>{{ gettext("Chon_loai_quy_doi") }}</option>
                    <option {% if loyal_settings and loyal_settings.loyal_type == "visit" %} selected {% endif %}
                        value="visit">{{ gettext("Quy_doi_theo_luot_den") }}</option>
                    <option {% if loyal_settings and loyal_settings.loyal_type == "money" %} selected {% endif %}
                        value="money">{{ gettext("Quy_doi_theo_tien_thanh_toan") }}</option>
                </select>
            </div>
        </div>
    </div>
    <div class="row u-mb-large" style="margin-top: 50px">


        <div id="trans_visit" class="col-lg-12" style="display: none;">
            <div class="c-card u-p-medium">
                <div class="c-table-responsive@desktop" style="padding-top: 20px;">
                    <form method="POST" action="" enctype="multipart/form-data">
                        <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}" />
                        <div class="panel panel-white">
                            <div class="panel-body">
                                <div class="row">
                                    <div class="col-md-12">

                                        <div class="header">
                                            {% if message %}
                                            <div class="alert alert-success">
                                                {{ message | safe }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="content">
                                            <!-- <div class="form-group form-inline">
                                                <input type="hidden" id="curr_loyal_type"
                                                    value="{% if loyal_settings %}{{ loyal_settings.loyal_type }}{% endif %}" />
                                                <label for="loyaly_exchange_value" style="padding-left: 10px">Giá trị quy đổi:</label>
                                                <input type="text" id="loyaly_exchange_value" class="form-control"
                                                    value="{% if loyal_settings %}{{ loyal_settings.value }}{% endif %}"
                                                    placeholder="1000" />
                                                <input type="text" class="form-control" value="= 1 điểm" readonly />
                                                <label for="active" style="padding-left: 10px">Triển khai:</label>

                                                <input type="checkbox" id="active"
                                                    {% if loyal_settings %}{% if loyal_settings.start %}checked{% endif %}{% endif %}>
                                            </div> -->
                                            <div class="header">
                                                <h4 for="active">{{ gettext("Muc_quy_doi:") }}</h4>
                                                <div class="btn-toolbar pull-right" style="margin-left: 30px">
                                                    <div class="btn-group">
                                                        <a href="#" id="save_loyalty"
                                                            class="c-btn c-btn--info pull-right">{{ gettext("Luu_lai") }}</a>
                                                    </div>
                                                </div>

                                                <div class="form-group" style="float: right">
                                                    <div class="c-switch {% if loyal_settings.status == 'True' and loyal_settings.loyal_type == 'visit' %}
                                                        is-active{% endif %}">
                                                        <input class="c-switch__input" name="status_visit"
                                                            id="status_visit" type="checkbox"
                                                            {% if loyal_settings.status == 'True' and loyal_settings.loyal_type == "visit" %}
                                                            checked="checked" {% endif %}>
                                                        {{ gettext("Kich_hoat") }}
                                                    </div>
                                                </div>

                                            </div>

                                            <div class="form-group form-inline">
                                                <input type="text" class="form-control" value="1 lượt đến" readonly />
                                                <label style="margin-left: 30px;">{{ gettext("Tuong_ung_so_diem:") }}</label>
                                                <input type="text" name="loyalty_visit_poi" id="loyalty_visit_poi"
                                                    class="form-control"
                                                    value="{% if loyal_settings %}{{ loyal_settings.loyalty_visit_poi }}{% endif %}"
                                                    style="margin-left: 22px;" placeholder="10" />
                                                <span class="form-group" id="errmsg_point_exchange"></span>
                                            </div>

                                            <!-- <div class="form-group form-inline">
                                                <input type="hidden" id="curr_loyal_type"
                                                    value="{% if loyal_settings %}{{ loyal_settings.loyal_type }}{% endif %}" />
                                                <input type="text" class="form-control" value="1 điểm" readonly />
                                                <label style="margin-left: 30px;"> Tương ứng số tiền :</label>
                                                <input type="text" name="loyalty_exchange_value"
                                                    id="loyalty_exchange_value" class="form-control"
                                                    value="{% if loyal_settings %}{{ loyal_settings.loyal_value }}{% endif %}"
                                                    style="margin-left: 30px;" placeholder="1,000" />
                                                <span class="form-group" id="errmsg_money_exchange"></span>
                                            </div> -->

                                            <div class="header">
                                                <h4 for="active">{{ gettext("Bat_dau_tu:") }}</h4>
                                            </div>
                                            <div class="form-group form-inline">
                                                <input type="text" name="sales_start_date" id="sales_start_date"
                                                    class="form-control form-input" value="{% if loyal_settings and loyal_settings.loyal_type == 'visit' %}
                                                    {{ loyal_settings.sales_start_date }}{% endif %}" />
                                                <input type="hidden" value="{{ loyal_settings.sales_start_date }}"
                                                    id="ex_sales_start_date" />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="header">
                                            <h4 class="title">{{ gettext("Hang_thanh_vien") }}</h4>
                                        </div>
                                        <div class="content">
                                            <div id="rank_content">
                                                {%if loyal_settings.loyal_type == "visit" and loyal_rank and loyal_rank|length >0%}
                                                {%for rank in loyal_rank%}
                                                <div class="form-group form-inline">

                                                    <input type="text" class="form-control" value="{{rank.name}}" />
                                                    <label style="margin-left: 30px;">{{ gettext("Tuong_ung_so_diem:") }} </label>
                                                    <input type="text" class="form-control" value="{{rank.point}}"
                                                        style="margin-left: 30px;" />
                                                </div>
                                                {%endfor%} {%else%}
                                                <div class="form-group form-inline">

                                                    <input type="text" class="form-control" value=""
                                                        placeholder='{{ gettext("Ten_hang") }}' />
                                                    <label style="margin-left: 30px;">{{ gettext("Tuong_ung_so_diem:") }}</label>
                                                    <input type="text" class="form-control" value=""
                                                        placeholder='{{ gettext("So_diem") }}' style="margin-left: 30px;" />
                                                </div>
                                                <div class="form-group form-inline">

                                                    <input type="text" class="form-control" value=""
                                                        placeholder='{{ gettext("Ten_hang") }}' />
                                                    <label style="margin-left: 30px;">{{ gettext("Tuong_ung_so_diem:") }}</label>
                                                    <input type="text" class="form-control" value=""
                                                        placeholder='{{ gettext("So_diem") }}' style="margin-left: 30px;" />
                                                </div>
                                                <div class="form-group form-inline">

                                                    <input type="text" class="form-control" value=""
                                                        placeholder='{{ gettext("Ten_hang") }}' />
                                                    <label style="margin-left: 30px;">{{ gettext("Tuong_ung_so_diem:") }}</label>
                                                    <input type="text" class="form-control" value=""
                                                        placeholder='{{ gettext("So_diem") }}' style="margin-left: 30px;" />
                                                </div>

                                                {%endif%}

                                            </div>
                                            <div class="btn-toolbar pull-left">
                                                <div class="btn-group">
                                                    <a href="#" id="add_rank"
                                                        class="btn btn-info btn-fill pull-right">{{ gettext("Them") }}</a>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>


                </div>
            </div>
        </div>
        <div class="col-lg-12" style="margin-top: 20px">
            <div id="trans_money" class="c-card u-p-medium" style="display: none;">
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="panel panel-white">
                                <div class="panel-body">
                                    <div class="row">
                                        <div class="col-md-12">

                                            <div class="header">
                                                {% if message %}
                                                <div class="alert alert-success">
                                                    {{ message | safe }}
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div class="content">
                                                <!-- <div class="form-group form-inline">
                                                        <input type="hidden" id="curr_loyal_type"
                                                            value="{% if loyal_settings %}{{ loyal_settings.loyal_type }}{% endif %}" />
                                                        <label for="loyaly_exchange_value" style="padding-left: 10px">Giá trị quy đổi:</label>
                                                        <input type="text" id="loyaly_exchange_value" class="form-control"
                                                            value="{% if loyal_settings %}{{ loyal_settings.value }}{% endif %}"
                                                            placeholder="1000" />
                                                        <input type="text" class="form-control" value="= 1 điểm" readonly />
                                                        <label for="active" style="padding-left: 10px">Triển khai:</label>
        
                                                        <input type="checkbox" id="active"
                                                            {% if loyal_settings %}{% if loyal_settings.start %}checked{% endif %}{% endif %}>
                                                    </div> -->
                                                <div class="header">
                                                    <h4 for="active">{{ gettext("Muc_quy_doi:") }}</h4>


                                                    <div class="btn-toolbar pull-right" style="margin-left: 30px;">
                                                        <div class="btn-group">
                                                            <button type="submit" id="save_credit"
                                                                class="c-btn c-btn--info">{{ gettext("Luu_lai") }}</button>
                                                        </div>
                                                    </div>
                                                    <div class="form-group" style="float: right">
                                                        <div
                                                            class="c-switch {% if loyal_settings.status and loyal_settings.loyal_type == 'money' and loyal_settings.status == 'True' %}is-active{% endif %}">
                                                            <input class="c-switch__input" name="status_money"
                                                                id="status_money" type="checkbox"
                                                                {% if loyal_settings.status == "True" and loyal_settings.loyal_type == "money" %}
                                                                checked="checked" {% endif %}>
                                                            {{ gettext("Kich_hoat") }}
                                                        </div>
                                                    </div>

                                                </div>
                                                <div class="form-group form-inline">
                                                    <input type="text" class="form-control"
                                                        value="{% if loyal_settings and loyal_settings.loyal_type == 'money' %}{{ loyal_settings.money_pay|jinja_currency_format }}{% endif %}"
                                                        placeholder='{{ gettext("So_tien_chi_tieu") }}' id="money_pay"
                                                        name="money_pay" />

                                                    <label style="margin-left: 30px;"> {{ gettext("Tuong_ung_so_diem:") }}</label>
                                                    <input type="text" name="money_pay_poi" id="money_pay_poi"
                                                        class="form-control"
                                                        value="{% if loyal_settings %}{{ loyal_settings.money_pay_poi }}{% endif %}"
                                                        style="margin-left: 22px;" placeholder="10" />
                                                    <span class="form-group" id="errmsg_point_exchange_mon"></span>
                                                </div>

                                                <!-- <div class="form-group form-inline">
                                                    <input type="hidden" id="curr_loyal_type"
                                                        value="{% if loyal_settings %}{{ loyal_settings.loyal_type }}{% endif %}" />
                                                    <input type="text" class="form-control" value="1" readonly
                                                        placeholder="1 điểm" />
                                                    <label style="margin-left: 30px;"> Tương ứng số tiền :</label>
                                                    <input type="text" name="loyalty_exchange_value_mon"
                                                        id="loyalty_exchange_value_mon" class="form-control"
                                                        value="{% if loyal_settings %}{{ loyal_settings.loyal_value }}{% endif %}"
                                                        style="margin-left: 30px;" placeholder="1,000" />
                                                    <span class="form-group" id="errmsg_money_exchange"></span>
                                                </div> -->

                                                <div class="header">
                                                    <h4 for="active">{{ gettext("Bat_dau_tu:") }}</h4>
                                                </div>
                                                <div class="form-group form-inline">
                                                    <input type="text" name="sales_start_date_mon"
                                                        id="sales_start_date_mon" class="form-control form-input"
                                                        value="{% if loyal_settings and loyal_settings.loyal_type == 'money' %}{{ loyal_settings.sales_start_date }}{% endif %}" />
                                                    <input type="hidden" value="{{ loyal_settings.sales_start_date }}"
                                                        id="ex_start_date_mon" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="header">
                                                <h4 class="title">{{ gettext("Hang_thanh_vien") }}</h4>
                                            </div>
                                            <div class="content">
                                                <div id="rank_content_money">
                                                    {%if loyal_settings.loyal_type == "money" and loyal_rank and loyal_rank|length >0%}
                                                    {%for rank in loyal_rank%}
                                                    <div class="form-group form-inline">

                                                        <input type="text" class="form-control" value="{{rank.name}}"
                                                            placeholder='{{ gettext("Ten_hang") }}' />
                                                        <label style="margin-left: 30px;">Tương ứng số điểm : </label>
                                                        <input type="text" class="form-control" value="{{rank.point}}"
                                                            placeholder='{{ gettext("So_diem") }}' style="margin-left: 30px;" />
                                                    </div>
                                                    {%endfor%} {%else%}
                                                    <div class="form-group form-inline">

                                                        <input type="text" class="form-control" value=""
                                                            placeholder='{{ gettext("Ten_hang") }}' />
                                                        <label style="margin-left: 30px;">{{ gettext("Tuong_ung_so_diem:") }} </label>
                                                        <input type="text" class="form-control" value=""
                                                            placeholder='{{ gettext("So_diem") }}' style="margin-left: 30px;" />
                                                    </div>
                                                    <div class="form-group form-inline">

                                                        <input type="text" class="form-control" value=""
                                                            placeholder='{{ gettext("Ten_hang") }}' />
                                                        <label style="margin-left: 30px;">{{ gettext("Tuong_ung_so_diem:") }} </label>
                                                        <input type="text" class="form-control" value=""
                                                            placeholder='{{ gettext("So_diem") }}' style="margin-left: 30px;" />
                                                    </div>
                                                    <div class="form-group form-inline">

                                                        <input type="text" class="form-control" value=""
                                                            placeholder='{{ gettext("Ten_hang") }}' />
                                                        <label style="margin-left: 30px;">{{ gettext("Tuong_ung_so_diem:") }} </label>
                                                        <input type="text" class="form-control" value=""
                                                            placeholder='{{ gettext("So_diem") }}' style="margin-left: 30px;" />
                                                    </div>

                                                    {%endif%}

                                                </div>
                                                <div class="btn-toolbar pull-left">
                                                    <div class="btn-group">
                                                        <a href="#" id="add_rank_money"
                                                            class="btn btn-info btn-fill pull-right">T{{ gettext("Them") }}</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="content">
                                                <div class="header">
                                                    <h4 class="title">{{ gettext("Tich_luy:") }}</h4>
                                                </div>
                                                <div id="reward_content">
                                                    {%if rewards and rewards|length >0 %} {% for reward in rewards %}
                                                    <div class="form-group form-inline" style="margin-top: 20px;">
                                                        <label>{{ gettext("Tien_chi_tieu:") }} </label>
                                                        <input type="text" class="form-control"
                                                            value="{{ reward.amount }}" style="margin-left: 20px;"
                                                            placeholder='{{ gettext("So_tien_chi_tieu") }}'/>
                                                        <label style="margin-left: 20px;">% {{ gettext("Tich:") }}</label>
                                                        <input type="text" style="width: 50px; margin-left: 20px;"
                                                            class="form-control" value="{{reward.credit}}"
                                                            placeholder="" /> %
                                                    </div>
                                                    {%endfor%} {%else%}
                                                    <div class="form-group form-inline">
                                                        <label>{{ gettext("Tien_chi_tieu:") }} </label>
                                                        <input type="text" class="form-control" value=""
                                                            style="margin-left: 20px;" placeholder='{{ gettext("So_tien_chi_tieu") }}' />
                                                        <label style="margin-left: 20px;">% {{ gettext("Tich:") }} </label>
                                                        <input type="text" class="form-control" value=""
                                                            style="width: 50px; margin-left: 20px;" placeholder="" /> %
                                                    </div>
                                                    <div class="form-group form-inline">
                                                        <label>{{ gettext("Tien_chi_tieu:") }} </label>
                                                        <input type="text" class="form-control" value=""
                                                            style="margin-left: 20px;" placeholder='{{ gettext("So_tien_chi_tieu") }}' />
                                                        <label style="margin-left: 20px;">% {{ gettext("Tich:") }} </label>
                                                        <input type="text" class="form-control" value=""
                                                            style="width: 50px; margin-left: 20px;" placeholder="" /> %
                                                    </div>
                                                    <div class="form-group form-inline">
                                                        <label>{{ gettext("Tien_chi_tieu:") }} </label>
                                                        <input type="text" class="form-control" value=""
                                                            style="margin-left: 20px;" placeholder='{{ gettext("So_tien_chi_tieu") }}' />
                                                        <label style="margin-left: 20px;">% {{ gettext("Tich:") }} </label>
                                                        <input type="text" class="form-control" value=""
                                                            style="width: 50px; margin-left: 20px;" placeholder="" /> %
                                                    </div>
                                                    {%endif%}
                                                </div>

                                                <div class="btn-toolbar pull-left">
                                                    <div class="btn-group">
                                                        <a href="#" id="add_reward"
                                                            class="btn btn-info btn-fill pull-right">{{ gettext("Them") }}</a>
                                                    </div>
                                                </div>


                                                <div class="clearfix"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block js %}
<script type="text/javascript">
    $(document).ready(function () {
        $("#loyal_type").select2();
        if ($("#loyal_type").val() == "visit") {
            $("#trans_visit").show();
            $("#trans_money").hide();
        }
        else {
            $("#trans_visit").hide();
            $("#trans_money").show();
        }
        $('#loyal_type').on('change.select2', function (e) {
            var loyal_type_select = $("#loyal_type").val();
            if (loyal_type_select == "money") {
                $("#trans_visit").hide();
                $("#trans_money").show();
            }
            else {
                $("#trans_visit").show();
                $("#trans_money").hide();
            }

        })
        if ($("#curr_loyal_type").length > 0) {
            $("#loyal_type").val($("#curr_loyal_type").val());
        }

        $("#add_rank").click(function () {
            var child_con = '<div class="form-group form-inline">';
            child_con += ' <input type="text" class="form-control" value="" placeholder=' + '\'{{ gettext(\"Ten_hang\") }}\'/>';
            child_con += ' <label style="margin-left: 30px;" >{{ gettext("Tuong_ung_so_diem:") }} </label> <input type="text" class="form-control" value="" placeholder=' + '\'{{ gettext(\"So_diem\") }}\'' + 'style="margin-left: 30px;"/>';
            $("#rank_content").append(child_con)

        });
        $("#add_rank_money").click(function () {
            var child_con =  '<div class="form-group form-inline">';
            child_con += ' <input type="text" class="form-control" value="" placeholder=' + '\'{{ gettext(\"Ten_hang\") }}\'/>';
            child_con += ' <label style="margin-left: 30px;" >{{ gettext("Tuong_ung_so_diem:") }} </label> <input type="text" class="form-control" value="" placeholder=' + '\'{{ gettext(\"So_diem\") }}\'' + 'style="margin-left: 30px;"/>';
            $("#rank_content_money").append(child_con)

        });

        $("#save_loyalty").click(function () {
            var status = $('#status_visit').is(":checked");
            var loyalty_visit_poi = $("#loyalty_visit_poi").val();
            var sales_start_date = $("#sales_start_date").val();
            if (loyalty_visit_poi.length == 0) {
                swal('{{ gettext("So_diem_tuong_ung_khong_duoc_bo_trong") }}', '', 'error');
                return false
            };
            if (sales_start_date.length == 0) {
                swal('{{ gettext("Thoi_gian_bat_dau_khong_duoc_bo_trong") }}', '', 'error');
                return false
            };
            var ranks = [];
            $("#rank_content").children('div.form-group').each(function (i) {
                var inputs_ranks = $(this).children("input");
                var name_ranks = $(inputs_ranks[0]).val();
                var points_ranks = $(inputs_ranks[1]).val();
                if (Number(points_ranks).toString() == "NaN") {
                    swal('{{ gettext("So_diem_xep_hang_phai_la_so") }}', '', 'error');
                    return false;
                }
                if (points_ranks.length > 0 && name_ranks.length > 0) {
                    var item = { 'point': Number(points_ranks), 'name': name_ranks };
                    ranks.push(item);
                }
            });
            var data = {
                'loyal_type': $("#loyal_type").val(),
                'status': status,
                'loyalty_visit_poi': loyalty_visit_poi,
                'sales_start_date': sales_start_date,
                'ranks': JSON.stringify(ranks)
            };

            $.ajax({
                type: 'POST',
                url: '/loyalty',
                data: data,
                success: function (response) {
                    var returnedData = JSON.parse(response);
                    if ('error' in returnedData) {
                        swal(returnedData['error'], " ", "error");
                        return false;
                    }
                    else {
                        swal('{{ gettext("Thao_tac_thanh_cong") }}', '', 'success');
                        location.reload();
                    }
                },
                error: function (xhr, desc, err) {
                    swal('{{ gettext("Co_loi_xay_ra,_thu_lai_sau") }}', '', 'error');
                }
            });

        });

        $("#add_reward").click(function () {
            var child_con = '<div class="form-group form-inline">';
            child_con += '<label>{{ gettext("Tien_chi_tieu:") }} </label> <input type="text" class="form-control" value="" style="margin-left: 20px;" placeholder=' + '\'{{ gettext(\"So_tien_chi_tieu\") }}\'' + ' />';
            child_con += ' <label style="margin-left: 20px;" >% {{ gettext("Tich:") }} </label> <input type="text" class="form-control" value="" placeholder="" style="width: 50px; margin-left: 20px;"/> %<div/>';
            $("#reward_content").append(child_con);

        });
        if ($("#ex_sales_start_date").length > 0 && $("#ex_sales_start_date").val().length > 0 && $("#ex_sales_start_date").val() != 'None' && $("#loyal_type_has").val() == "visit") {
            var to_date_arr = $("#ex_sales_start_date").val().split('-');
            var to_date = to_date_arr[0] + '-' + to_date_arr[1] + '-' + to_date_arr[2];
            flatpickr("#sales_start_date", {
                enableTime: false,
                defaultDate: to_date,
                dateFormat: "d-m-Y"
            });
        } else {
            flatpickr("#sales_start_date", {
                enableTime: false,
                dateFormat: "d-m-Y"
            });
        }
        if ($("#ex_start_date_mon").length > 0 && $("#ex_start_date_mon").val().length > 0 && $("#ex_start_date_mon").val() != 'None' && $("#loyal_type_has").val() == "money") {
            var to_date_arr = $("#ex_start_date_mon").val().split('-');
            var to_date = to_date_arr[0] + '-' + to_date_arr[1] + '-' + to_date_arr[2];
            flatpickr("#sales_start_date_mon", {
                enableTime: false,
                defaultDate: to_date,
                dateFormat: "d-m-Y"
            });
        } else {
            flatpickr("#sales_start_date_mon", {
                enableTime: false,
                dateFormat: "d-m-Y"
            });
        }
        $("#save_credit").click(function () {
            var status = $('#status_money').is(":checked");
            var rewards = [];
            var ranks = [];
            var money_pay = $("#money_pay").val();
            var sales_start_date = $("#sales_start_date_mon").val();
            if (money_pay.length == 0) {
                swal('{{ gettext("Muc_quy_doi_khong_duoc_bo_trong") }}', '', 'error');
                return false;
            }
            var money_pay_poi = $("#money_pay_poi").val();
            if (sales_start_date.length == 0) {
                swal('{{ gettext("Thoi_gian_bat_dau_khong_duoc_bo_trong") }}', '', 'error');
                return false
            };
            if (money_pay_poi.length == 0) {
                swal('{{ gettext("Muc_quy_doi_khong_duoc_bo_trong") }}', '', 'error');
                return false;
            }
            $("#reward_content").children('div.form-group').each(function (i) {
                var inputs = $(this).children("input");
                var amount = $(inputs[0]).val();
                var credit = $(inputs[1]).val();
                if (Number(amount).toString() == "NaN" || Number(credit).toString() == "NaN") {
                    swal('{{ gettext("So_diem_xep_hang_phai_la_so") }}', '', 'error');
                    return false;
                }
                else {
                    if (amount.length > 0 && credit.length > 0) {
                        var item = { 'amount': amount, 'credit': credit };
                        rewards.push(item);
                    }
                }
            });
            $("#rank_content_money").children('div.form-group').each(function (i) {
                var inputs = $(this).children("input");
                var name_ranks = $(inputs[0]).val();
                var points_ranks = $(inputs[1]).val();
                if (Number(points_ranks).toString() == "NaN") {
                    swal('{{ gettext("So_diem_xep_hang_phai_la_so") }}', '', 'error');
                    return false;
                }
                if (name_ranks.length > 0 && points_ranks.length > 0) {
                    var item = { 'name': name_ranks, 'point': points_ranks };
                    ranks.push(item);
                }
            });

            var data_money = {
                'loyal_type': "money",
                'money_pay': money_pay,
                'status': status,
                'money_pay_poi': money_pay_poi,
                'sales_start_date': sales_start_date,
                'rewards': JSON.stringify(rewards),
                'ranks': JSON.stringify(ranks),
            };

            $.ajax({
                type: 'POST',
                url: '/loyalty',
                data: data_money,
                success: function (response) {
                    var returnedData = JSON.parse(response);
                    if ('error' in returnedData) {
                        swal(returnedData['error'], " ", "error");
                        return false;
                    }
                    else {
                        swal('{{ gettext("Thao_tac_thanh_cong") }}', '', 'success');
                        location.reload();
                    }
                },
                error: function (xhr, desc, err) {
                    swal('{{ gettext("Co_loi_xay_ra,_thu_lai_sau") }}', '', 'error');
                }

            });
        })
        $("#money_pay").on({
            keyup: function () {
                formatCurrency($(this));
            },
            blur: function () {
                formatCurrency($(this), "blur");
            }
        });
        // $("#loyalty_exchange_value_mon").on({
        //     keyup: function () {
        //         formatCurrency($(this));
        //     },
        //     blur: function () {
        //         formatCurrency($(this), "blur");
        //     }
        // });
        // $("#loyalty_exchange_value").on({
        //     keyup: function () {
        //         formatCurrency($(this));
        //     },
        //     blur: function () {
        //         formatCurrency($(this), "blur");
        //     }
        // });


        function formatNumber(n) {
            // format number 1000000 to 1,234,567
            return n.replace(/\D/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ",")
        }


        function formatCurrency(input, blur) {
            // appends $ to value, validates decimal side
            // and puts cursor back in right position.

            // get input value
            var input_val = input.val();

            // don't validate empty input
            if (input_val === "") { return; }

            // original length
            var original_len = input_val.length;

            // initial caret position 
            var caret_pos = input.prop("selectionStart");

            // check for decimal
            if (input_val.indexOf(".") >= 0) {

                // get position of first decimal
                // this prevents multiple decimals from
                // being entered
                var decimal_pos = input_val.indexOf(".");

                // split number by decimal point
                var left_side = input_val.substring(0, decimal_pos);
                var right_side = input_val.substring(decimal_pos);

                // add commas to left side of number
                left_side = formatNumber(left_side);

                // validate right side
                right_side = formatNumber(right_side);

                // On blur make sure 2 numbers after decimal

                // Limit decimal to only 2 digits
                right_side = right_side.substring(0, 2);

                // join number by .
                input_val = left_side + "." + right_side;

            } else {
                // no decimal entered
                // add commas to number
                // remove all non-digits
                input_val = formatNumber(input_val);
                input_val = input_val;

                // final formatting

            }

            // send updated string to input
            input.val(input_val);

            // put caret back in the right position
            var updated_len = input_val.length;
            caret_pos = updated_len - original_len + caret_pos;
            input[0].setSelectionRange(caret_pos, caret_pos);
        }

        $("#money_pay").keypress(function (e) {
            //if the letter is not digit then display error and don't type anything
            if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)) {
                //display error message

                return false;
            }
        });
        $("#loyalty_exchange_value").keypress(function (e) {
            //if the letter is not digit then display error and don't type anything
            if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)) {
                //display error message
                $("#errmsg_money_exchange").html("{{ gettext('Chi_duoc_nhap_so') }}").show().fadeOut("slow");
                return false;
            }
        });
        $("#loyalty_visit_poi").keypress(function (e) {
            //if the letter is not digit then display error and don't type anything
            if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)) {
                //display error message
                $("#errmsg_point_exchange").html("{{ gettext('Chi_duoc_nhap_so') }} ").show().fadeOut("slow");
                return false;
            }
        });
        $("#money_pay_poi").keypress(function (e) {
            //if the letter is not digit then display error and don't type anything
            if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)) {
                //display error message
                $("#errmsg_point_exchange_mon").html("{{ gettext('Chi_duoc_nhap_so') }}").show().fadeOut("slow");
                return false;
            }
        })
    });

</script> {% endblock %}
<style>
    .form-control {

        display: block;
        width: 100%;
        height: calc(2.25rem + 2px);
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
        color: #495057;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    @media screen and (prefers-reduced-motion: reduce) {
        .form-control {
            transition: none;
        }
    }

    .form-control::-ms-expand {
        background-color: transparent;
        border: 0;
    }

    .form-control:focus {
        color: #495057;
        background-color: #fff;
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .form-control::-webkit-input-placeholder {
        color: #6c757d;
        opacity: 1;
    }

    .form-control::-moz-placeholder {
        color: #6c757d;
        opacity: 1;
    }

    .form-control:-ms-input-placeholder {
        color: #6c757d;
        opacity: 1;
    }

    .form-control::-ms-input-placeholder {
        color: #6c757d;
        opacity: 1;
    }

    .form-control::placeholder {
        color: #6c757d;
        opacity: 1;
    }

    .form-control:disabled,
    .form-control[readonly] {
        background-color: #e9ecef;
        opacity: 1;
    }

    select.form-control:focus::-ms-value {
        color: #495057;
        background-color: #fff;
    }

    .form-control-file,
    .form-control-range {
        display: block;
        width: 100%;
    }

    /* .form-group {
        margin-bottom: 1rem;
    } */

    form-inline {
        display: -ms-flexbox;
        display: flex;
        -ms-flex-flow: row wrap;
        flex-flow: row wrap;
        -ms-flex-align: center;
        align-items: center;
    }

    .form-inline .form-check {
        width: 100%;
    }

    @media (min-width: 576px) {
        .form-inline .form-group {
            display: -ms-flexbox;
            display: flex;
            -ms-flex: 0 0 auto;
            flex: 0 0 auto;
            -ms-flex-flow: row wrap;
            flex-flow: row wrap;
            -ms-flex-align: center;
            align-items: center;
            margin-bottom: 0;
        }

        .form-inline .form-control {
            display: inline-block;
            width: auto;
            vertical-align: middle;
        }

        .form-inline .form-control-plaintext {
            display: inline-block;
        }

        .form-inline .input-group,
        .form-inline .custom-select {
            width: auto;
        }

        .form-inline .form-check {
            display: -ms-flexbox;
            display: flex;
            -ms-flex-align: center;
            align-items: center;
            -ms-flex-pack: center;
            justify-content: center;
            width: auto;
            padding-left: 0;
        }

        .form-inline .form-check-input {
            position: relative;
            margin-top: 0;
            margin-right: 0.25rem;
            margin-left: 0;
        }

        .form-inline .custom-control {
            -ms-flex-align: center;
            align-items: center;
            -ms-flex-pack: center;
            justify-content: center;
        }

        .form-inline .custom-control-label {
            margin-bottom: 0;
        }
    }

    label {
        display: inline-block;
        max-width: 100%;
        margin-bottom: 5px;
        font-weight: 700;
    }
</style>